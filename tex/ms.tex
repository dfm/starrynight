% !TeX root = ./ms.tex
\documentclass[modern]{aastex62}

% Load the corTeX style definitions
\input{cortex}

% Shorthand for this paper
\usepackage{xifthen}
\newcommand{\BF}[1]{\ensuremath{\mathbf{#1}}}
\newcommand{\BS}[1]{\ensuremath{\boldsymbol{#1}}}
\newcommand{\dd}{\ensuremath{\mathrm{d}}}
\newcommand{\STARRYQUADPOINTS}{100\xspace}
\newcommand{\bkappa}{\BS{\kappa}}
\newcommand{\blambda}{\BS{\lambda}}
\newcommand{\bxi}{\BS{\xi}}
\newcommand{\vmax}{{v_\mathrm{max}}}
\newcommand{\kapint}[1]{%
\sum_{i = 0}^{\frac{N - 1}{2}}
\int\limits_{\frac{1}{2}\kappa_{2i}}^{\frac{1}{2}\kappa_{2i+1}}
#1
\dd\varphi
}
\newcommand{\lamint}[1]{%
\sum_{i = 0}^{\frac{N - 1}{2}}
\int\limits_{\frac{1}{2}\lambda_{2i}}^{\frac{1}{2}\lambda_{2i+1}}
#1
\dd\varphi
}
\newcommand{\coshalfkap}[1][]{%
\ifthenelse{%
    \equal{#1}{}
}{
    \cos\left(\frac{\bkappa}{2}\right)
}{
    \cos^{#1}\left(\frac{\bkappa}{2}\right)
}}
\newcommand{\sinhalfkap}[1][]{%
\ifthenelse{%
    \equal{#1}{}
}{
    \sin\left(\frac{\bkappa}{2}\right)
}{
    \sin^{#1}\left(\frac{\bkappa}{2}\right)
}}
\newcommand{\DE}{\Delta \BS{E}(k^2, \bkappa)}
\newcommand{\DF}{\Delta \BS{F}(k^2, \bkappa)}
\newcommand{\sgn}{{\mathrm{sgn}}}
\newcommand{\xhat}{\ensuremath{\mathbf{\hat{x}}}\xspace}
\newcommand{\yhat}{\ensuremath{\mathbf{\hat{y}}}\xspace}
\newcommand{\zhat}{\ensuremath{\mathbf{\hat{z}}}\xspace}
\newcommand{\sT}{\ensuremath{\mathfrak{s}^\top}}
\newcommand{\rT}{\ensuremath{\mathfrak{r}^\top}}
\newcommand{\sTe}{\ensuremath{\BF{s}^\top}}
\newcommand{\rTe}{\ensuremath{\BF{r}^\top}}
%
\newcommand{\bg}{\ensuremath{\tilde{\BF{g}}}}
\newcommand{\bp}{\ensuremath{\tilde{\BF{p}}}}
\newcommand{\by}{\ensuremath{\tilde{\BF{y}}}}

% Bibliography stuff
\bibliographystyle{aasjournal}

% Begin!
\begin{document}

% Title
\title{Analytic Occultation Light Curves in Reflected Light}

% Author list
\author[0000-0002-0296-3826]{Rodrigo Luger}
\email{rluger@flatironinstitute.org}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}
%

\begin{abstract}
    Abstract here.
    %
    \href{https://github.com/rodluger/starrynight}{\color{linkcolor}\faGithub}
\end{abstract}

%
\section{Introduction}
\label{sec:intro}
%
This is an extension of \citet{Luger2019}.

%
\section{The Problem}
\label{sec:the-problem}
%
\textbf{Note:}
This section closely follows the
notation and formalism introduced in \citet{Luger2019}. While we
include all of the relevant equations and definitions in
Appendix~\ref{app:starry}, the reader is strongly encouraged to
review \S2--3 of \citet{Luger2019} before proceeding.

\subsection{Review of the \starry algorithm in emitted light}
\label{sec:starry-review}
%
Without loss of generality, assume the body whose flux we wish to compute
has radius unity and sits at the origin of a right-handed Cartesian coordinate
system with the $x$-axis pointing to the right on the sky, the $y$-axis
pointing up on the sky, and the $z$-axis pointing out of the sky
toward the observer; denote this frame by $\mathcal{F}_0$. In $\mathcal{F}_0$,
the surface (emitted) intensity field of the body is described by the
spherical harmonic coefficient vector $\mathbf{y}$. Following
\citet{Luger2019}, when no occultor is present, we may compute the total
visible flux $f_0$ from this body as
%
\begin{align}
    \label{eq:rTA1Ry}
    f_0 = \rTe \BF{A_1} \BF{R} \BF{y}
    \quad,
\end{align}
%
where, from right to left, $\BF{R} = \BF{R}(i, \lambda, \vartheta)$
is a Wigner rotation matrix that rotates $\bvec{y}$ to the sky frame
$\mathcal{F}_\mathrm{sky}$ given the body's inclination $i$, obliquity
$\lambda$, and rotational phase $\vartheta$ (Equation~\ref{eq:R}),
%
$\BF{A_1}$ is the change-of-basis matrix from the spherical harmonic
basis $\by$ to the \emph{polynomial basis} $\bp$ in which the integrals
are computed (Equations~\ref{eq:by}, \ref{eq:bp}, and \ref{eq:A1}),
%
and $\rTe$ is the vector of solutions to the integral over
the projected visible disk of the body for each term in $\bp$
(Equation~\ref{eq:rTe}).
%
If instead an occultor of radius $r_o$ is located at position $(x_o, y_o)$,
we instead compute the visible flux $f$ from
%
\begin{align}
    \label{eq:sTARRy}
    f = \sTe \BF{A} \BF{R}' \BF{R} \BF{y}
    \quad,
\end{align}
%
where, as before, $\BF{R}$ rotates the body from $\mathcal{F}_0$
to $\mathcal{F}_\mathrm{sky}$,
%
$\BF{R}' = \BF{R}'(\omega)$ rotates the body on the plane
of the sky by an angle
$\omega = \mathrm{arctan2}(x_o, y_o)$
into a frame $\mathcal{F}_\mathrm{greens}$ in which the
occultor lies along the $+y$-axis (Equation~\ref{eq:R'}),
%
$\BF{A}$ is the change-of-basis matrix from $\by$
to the \emph{Green's basis} $\bg$ in which the integrals are computed
(Equation~\ref{eq:A}),
%
and $\sTe = \sTe(b_o, r_o)$ is the vector of solutions to the integral over
the projected visible disk of the body for each term in $\bg$
(Equation~\ref{eq:sTe}), with $b_o = \sqrt{x_o^2 + y_o^2}$.
For more details, see Appendix~\ref{app:starry} and \citet{Luger2019}.

\subsection{Adapting the algorithm to the reflected light case}
\label{sec:starry-review}
%
In order to compute light curves in reflected light, we must make two
modifications to the \starry algorithm. First,
the expressions above assume that the coefficient vector
$\mathbf{y}$ describes the \emph{emissivity} of the body, which (in the
absence of limb darkening) is assumed to be Lambertian, i.e., all points on the
surface emit equally in all directions.
Here, we wish to derive the solution for the flux in the case of Lambertian
reflectance, in which case the vector $\mathbf{y}$ is taken to describe the
surface \emph{reflectivity} (or \emph{Bond albedo}).

Second, we must explicitly model the illumination of the body. We assume the
body is illuminated by a point-like source of unit luminosity, in which case
the radiance at any
point on the surface is proportional to the cosine of the angle $\phi$ between
the incident light and the surface normal. Points for which
$\phi \ge \frac{\pi}{2}$ are unilluminated and therefore have radiance of zero.
%
If the point-like illumination source is placed at sky coordinates
$(x_s, y_s, z_s)$, the day/night terminator on the body is a half-ellipse
of semi-major axis unity that is fully described by its (signed) semi-minor
axis,
%
\begin{proof}{}
    \label{eq:b}
    b = -\frac{z_s}{r_s}
    \quad,
\end{proof}
%
where $r_s = \sqrt{x_s^2 + y_s^2 + z_s^2}$ is the distance to the source,
%
and the angle by which its semi-major axis is rotated away from the
$+x$-axis \xxx{CHECK ME},
%
\begin{proof}{}
    \label{eq:theta}
    \theta &=
    \begin{cases}
        -\mathrm{arctan2}(x_s, y_s)
         & \qquad \mathcal{F} = \mathcal{F}_\mathrm{term}   \\
        \omega - \mathrm{arctan2}(x_s, y_s)
         & \qquad \mathcal{F} = \mathcal{F}_\mathrm{greens}
        \quad.
    \end{cases}
\end{proof}
%
Given this formulation, and assuming that
$r_s \gg 1$,
it is straightforward to show that the illumination
$\mathfrak{I}$ at a point $(x, y)$ on the projected disk of the body is given
by the function
%
\begin{proof}{}
    \label{eq:Psi}
    \mathfrak{I}(b, \theta, r_s; x, y)&=
    \mathrm{max}\bigg( 0, I(b, \theta, r_s; x, y) \bigg)
\end{proof}
%
where
%
\begin{proof}{}
    I(b, \theta, r_s; x, y) &= \frac{1}{4\pi r_s^2}
    \bigg(
    -b_c\sin\theta x + b_c\cos\theta y - bz(x, y)
    \bigg)
\end{proof}
%
with $b_c = \sqrt{1 - b^2}$ and $z(x, y) = \sqrt{1 - x^2 - y^2}$.
%
Since $I$ is just a polynomial in $x$, $y$, and $z(x, y)$, we
can express it as a vector $\BF{i}(b, \theta)$ in the polynomial basis $\bp$.
Recalling the structure of the basis (Equation~\ref{eq:bp}),
we may write
%
\begin{proof}{}
    \BF{i}(b, \theta, r_s) & =
    \frac{1}{4\pi r_s^2}
    \begin{pmatrix}
        0              \\
        -b_c\sin\theta \\
        -b             \\
        b_c\cos\theta
    \end{pmatrix}
    \quad.
\end{proof}
%
This fact allows us to construct a linear operator $\BF{I}$ to weight a map
vector in the polynomial basis by the illumination profile.
If we think about how each of the terms in $\bp$ transforms under $\BF{I}$,
%
\\[1em]
%
\begin{minipage}{0.22\linewidth}
    \begin{align}
        \begin{pmatrix}
            1 \\
            0 \\
            0 \\
            0
        \end{pmatrix}
         & \BS{\rightarrow}
        \begin{pmatrix}
            \bvec{i}_0 \\ %1
            \bvec{i}_1 \\ %x
            \bvec{i}_2 \\ %z
            \bvec{i}_3 \\ %y
            0          \\ %x^2
            0          \\ %xz
            0          \\ %xy
            0          \\ %yz
            0             %y^2
        \end{pmatrix}
        \nonumber
    \end{align}
\end{minipage}
%
\begin{minipage}{0.22\linewidth}
    \begin{align}
        \begin{pmatrix}
            0 \\
            1 \\
            0 \\
            0
        \end{pmatrix}
         & \BS{\rightarrow}
        \begin{pmatrix}
            0          \\ %1
            \bvec{i}_0 \\ %x
            0          \\ %z
            0          \\ %y
            \bvec{i}_1 \\ %x^2
            \bvec{i}_2 \\ %xz
            \bvec{i}_3 \\ %xy
            0          \\ %yz
            0    %y^2
        \end{pmatrix}
        \nonumber
    \end{align}
\end{minipage}
%
\begin{minipage}{0.22\linewidth}
    \begin{align}
        \begin{pmatrix}
            0 \\
            0 \\
            1 \\
            0
        \end{pmatrix}
         & \BS{\rightarrow}
        \begin{pmatrix}
            \bvec{i}_2  \\ %1
            0           \\ %x
            \bvec{i}_0  \\ %z
            0           \\ %y
            -\bvec{i}_2 \\ %x^2
            \bvec{i}_1  \\ %xz
            0           \\ %xy
            \bvec{i}_3  \\ %yz
            -\bvec{i}_2    %y^2
        \end{pmatrix}
        \nonumber
    \end{align}
\end{minipage}
%
\begin{minipage}{0.22\linewidth}
    \begin{align}
        \begin{pmatrix}
            0 \\
            0 \\
            0 \\
            1
        \end{pmatrix}
         & \BS{\rightarrow}
        \begin{pmatrix}
            0          \\ %1
            0          \\ %x
            0          \\ %z
            \bvec{i}_0 \\ %y
            0          \\ %x^2
            0          \\ %xz
            \bvec{i}_1 \\ %xy
            \bvec{i}_2 \\ %yz
            \bvec{i}_3    %y^2
        \end{pmatrix}
        \nonumber
    \end{align}
\end{minipage}
\begin{minipage}{0.05\linewidth}
    \begin{align}
    \end{align}
\end{minipage}
%
\\[1em]
%
we can compose $\BF{I}$ out of these column vectors:
%
\begin{proof}{}
    \BF{I}(b, \theta, r_s) & =
    \frac{1}{4\pi r_s^2}
    \begin{pmatrix}
        0              & 0              & -b             & 0              & \cdots \\
        -b_c\sin\theta & 0              & 0              & 0              & \cdots \\
        -b             & 0              & 0              & 0              & \cdots \\
        b_c\cos\theta  & 0              & 0              & 0              & \cdots \\
        0              & -b_c\sin\theta & b              & 0              & \cdots \\
        0              & -b             & -b_c\sin\theta & 0              & \cdots \\
        0              & b_c\cos\theta  & 0              & -b_c\sin\theta & \cdots \\
        0              & 0              & b_c\cos\theta  & -b             & \cdots \\
        0              & 0              & b              & b_c\cos\theta  & \cdots \\
        \vdots         & \vdots         & \vdots         & \vdots         & \ddots
    \end{pmatrix}
\end{proof}
%
where the dimensions of the matrix are $\big((l + 2)^2, (l + 1)^2\big)$, where
$l$ is the spherical harmonic degree of the map (this operator raises the
degree of the map by one).
%
Note, importantly, that this weighting is valid only on the dayside
hemisphere (see Equation~\ref{eq:Psi}), as the operator $\BF{I}$ weights
points on the nightside by a \emph{negative} amount, which is clearly
unphysical. As we will see momentarily, we account for this by excluding the
nightside from the integration region in our flux integrals.

\begin{figure}[t!]
    \begin{centering}
        \includegraphics[width=\linewidth]{figures/frames.pdf}
        \oscaption{frames}{%
            How \starry computes the flux from a body in reflected light,
            tracking each of the linear transformations from the input map
            (far right) to the output (far left). The label below each map
            denotes the reference frame, while the label above
            each map denotes the basis in which the map is represented.
            Arrows indicate linear operations and are labeled accordingly.
            The upper branch corresponds to the unocculted case, while the
            lower branch corresponds to the case where an occultor is present.
            See text for details.
            \label{fig:frames}
        }
    \end{centering}
\end{figure}

We may now re-write Equations~(\ref{eq:rTA1Ry}) and (\ref{eq:sTARRy}) to
account for this illumination transformation. The flux outside of occultation
is now given by
%
\begin{align}
    \label{eq:rTIA1RRy}
    f_0 & =
    \mathfrak{r}^\top(b)
    \BF{I}(b, 0, r_s)
    \BF{A_1}
    \BF{R}'(-\theta)
    \BF{R}(i, \lambda, \vartheta)
    \BF{y}
    \quad,
\end{align}
%
and the flux during an occultation by
%
\begin{align}
    \label{eq:sTA2IA1RRy}
    f & =
    \mathfrak{s}^\top(b, \theta, b_o, r_o)
    \BF{A_2}
    \BF{I}(b, \theta, r_s)
    \BF{A_1}
    \BF{R}'(\omega)
    \BF{R}(i, \lambda, \vartheta)
    \BF{y}
    \quad.
\end{align}
%
A few notes about these equations are in order.
First, we now apply a rotation matrix $\BF{R}'(-\theta)$
(Equation~\ref{eq:R'}) to the unocculted case,
which rotates the body so the semi-major axis of the terminator is aligned
with the $x$-axis; as will become clear in \S\ref{sec:solution-no-occ} below,
this greatly simplifies the integration step. Note the corresponding change
in $\BF{I}$, which we call with $\theta = 0$.
%
Second, in the derivation of Equation~(\ref{eq:sTA2IA1RRy})
we used the fact that $\BF{A} = \BF{A_2} \BF{A_1}$
(Equation~\ref{eq:A}), where $\BF{A_1}$ transforms from
the spherical harmonic basis $\by$ to the polynomial basis $\bp$, and
$\BF{A_2}$ transforms from $\bp$ to the Green's basis $\bg$.
Finally, note that we replaced the integral vectors
$\rTe$ and $\sTe(b_o, r_o)$
with the vectors
$\mathfrak{r}^\top(b)$ and $\mathfrak{s}^\top(b, \theta, b_o, r_o)$,
respectively.
As we mentioned above, we must modify the integration limits to exclude the
nightside, where the weighting by $\BF{I}$ is unphysical.
The vectors $\mathfrak{r}^\top$ and $\mathfrak{s}^\top$ correspond to these
modified integrals, which we devote the rest of this paper to
computing.

Figure~\ref{fig:frames} summarizes the transformations involved in the two
equations above. Starting on the right with a map vector $\BF{y}$ in
the spherical harmonic basis $\by$, defined in some observer-independent frame
$\mathcal{F}_0$, we first rotate it via $\BF{R}$ to the sky frame
$\mathcal{F}_\mathrm{sky}$, in which orientation the body is viewed by the
observer. If there is no occultation (upper branch of the figure), we then
rotate the map once more via $\BF{R}'$ to the integration frame
$\mathcal{F}_\mathrm{term}$, in which the terminator is parallel to the
$x$-axis. We then apply $\BF{A_1}$ to change basis to $\bp$, apply the
illumination transform $\BF{I}$, and finally dot in the solutions to the
surface integrals $\rT$. If, on the other hand, an occultor is present,
we rotate the map from $\mathcal{F}_\mathrm{sky}$ via $\BF{R}'$ to the frame
$\mathcal{F}_\mathrm{greens}$, in which the occultor lies along the
$+y$-axis. We then apply $\BF{A_1}$ to change basis to $\bp$ and $\BF{I}$
to weight the map by the illumination as above. Finally, we change basis
via $\BF{A_2}$ to the Green's basis, in which we compute and dot the
integrals $\sT$.

%

\section{The Solution: No Occultation}
\label{sec:solution-no-occ}
%
Before we tackle configurations involving occultations, we must address the
simpler problem of computing the total visible flux from an unocculted
body in reflected light (Equation~\ref{eq:rTIA1RRy}). This problem was
originally solved by \citet{Haggard2018} and subsequently by
\citet{Luger2019b}, but for completeness we present the detailed
derivation in the \starry formalism here.

As we discussed above, we perform the integration in a frame
$\mathcal{F}_\mathrm{term}$
in which the semi-major axis of the terminator is aligned with the
$x$-axis, with the illumination source at $y \ge 0$.
The solution vector may then be computed from
%
\begin{align}
    \label{eq:rT}
    \rT(b) & =
    \int_{-1}^{1}
    \int_{b\sqrt{1 - x^2}}^{\sqrt{1 - x^2}}
    \bp(x, y)
    \ \dd y \ \dd x
    \quad,
\end{align}
%
which is identical to Equation~(20) in \citet{Luger2019} except for the
lower integration limit of the inner integral. The lower limit is now
the equation describing the terminator, which ensures we always exclude the
nightside from the integration region.
%
For computational efficiency, in practice we compute the integral of the
intensity-weighted basis directly,
%
\begin{align}
    \label{eq:rTI}
    \BS{\rho}^\top(b, r_s) & \equiv
    \rT(b) \mathbf{I}(b, 0, r_s)
    \nonumber                       \\
                           & =
    \int_{-1}^{1}
    \int_{b\sqrt{1 - x^2}}^{\sqrt{1 - x^2}}
    \bp(x, y)
    \mathbf{I}(b, 0, r_s)
    \ \dd y \ \dd x
    \quad,
\end{align}
%
recalling that in frame $\mathcal{F}_\mathrm{term}$, $\theta = 0$ by
definition.
%
Equation~(\ref{eq:rTI}) may be solved analytically in terms of purely
trigonometric and algebraic functions of $b$. The component of $\BS{\rho}^\top$
at index $n$ is given by
%
\begin{proof}{}
    \label{eq:rTsoln}
    \rho_n(b, r_s) & =
    \frac{1}{4\pi r_s^2}
    \begin{cases}
        \frac{b_c\left(1 - b^{\frac{\nu + 4}{2}}\right)}{2}
        J_{\frac{\mu}{2}, \frac{\nu + 2}{2}} -
        b I_\frac{\nu}{2}(b) K_{\frac{\mu}{2}, \frac{\nu}{2}}
        %
         &
        %
        \qquad
        \mu, \nu \ \mathrm{even}
        %
        \\[1em]
        %
        b_c
        I_{\frac{\nu + 1}{2}}(b) K_{\frac{\mu - 1}{2}, \frac{\nu + 1}{2}}
        %
        \\[0.5em]
        \qquad
        %
        - \frac{b}{2} \bigg\{
        \left(1 - b^{\frac{\nu + 1}{2}}\right)
        \left(
        J_{\frac{\mu - 1}{2}, \frac{\nu - 1}{2}} -
        J_{\frac{\mu + 3}{2}, \frac{\nu - 1}{2}}
        \right)
        \\[0.5em]
        \qquad\qquad
        -
        \left(1 - b^{\frac{\nu + 5}{2}}\right)
        J_{\frac{\mu - 1}{2}, \frac{\nu + 3}{2}}
        \bigg\}
        %
         &
        %
        \qquad
        \mathrm{otherwise}
        %
    \end{cases}
\end{proof}
%
where we make use of the indices
%
\begin{align}
    \label{eq:l-m-mu-nu}
    \mu & = l - m
    \nonumber                 \\
    \nu & = l + m
    \nonumber                 \\
    l   & = \floor*{\sqrt{n}}
    \nonumber                 \\
    m   & = n - l^2 - l
\end{align}
%
as in \citet{Luger2019} and we define the helper functions
%
\begin{proof}{}
    \label{eq:HJK}
    H_{j}(b) &= \int_b^1 a^j \sqrt{1 - a^2} \dd a
    \nonumber \\
    %
    J_{i,j} &=
    \frac{
        \Gamma\left(\frac{i + 1}{2}\right)
        \Gamma\left(\frac{j + 1}{2}\right)
    }
    {
        \Gamma\left(\frac{i + j + 4}{2}\right)
    }
    %
    \nonumber \\
    %
    K_{i,j} &=
    \frac{
        \Gamma\left(\frac{i + 1}{2}\right)
        \Gamma\left(\frac{j + 4}{2}\right)
    }
    {
        \Gamma\left(\frac{i + j + 5}{2}\right)
    }
    \quad.
\end{proof}
%
Given initial conditions
%
\\[1em]
\begin{minipage}{.33\linewidth}
    \begin{align}
        H_{0}(b) & = \frac{\arccos(b) - bb_c}{2}
        %
        \nonumber                                \\
        %
        H_{1}(b) & = \frac{b_c^3}{3}
        %
        \nonumber
    \end{align}
\end{minipage}%
\begin{minipage}{.32\linewidth}
    \begin{align}
        J_{0,0} & = \pi
        %
        \nonumber               \\
        %
        J_{0,1} & = \frac{4}{3}
        %
        \nonumber
    \end{align}
\end{minipage}%
\begin{minipage}{.33\linewidth}
    \begin{proof}{}
        \label{eq:IJK0}
        K_{0,0} &= \frac{4}{3}
        %
        \nonumber \\
        K_{0,1} &= \frac{3\pi}{8}
    \end{proof}
\end{minipage}
\\[1em]
%
we may compute all higher order terms from the recurrence relations
%
\begin{proof}{}
    \label{eq:IJKrec}
    H_{j}(b) &= \frac{b^n b_c^3 + (j - 1) H_{j - 2}(b)}{j + 2}
    %
    \nonumber \\
    %
    J_{0,j} &= \left(\frac{j - 1}{j + 2}\right) J_{0,j-2}
    %
    \nonumber \\
    %
    K_{0,j} &= \left(\frac{j + 2}{j + 3}\right) K_{0,j-2}
    %
    \nonumber \\
    %
    J_{i,j} &= \left(\frac{i - 1}{i + j + 2}\right) J_{i-2,j}
    %
    \nonumber \\
    %
    K_{i,j} &= \left(\frac{i - 1}{i + j + 3}\right) K_{i-2,j}
    \quad.
\end{proof}
%
Once $\BS{\rho}^\top$ is known, the observed flux is computed from
(c.f. Equation~\ref{eq:rTIA1RRy})
%
\begin{proof}{}
    \label{eq:f0}
    f_0 & =
    \BS{\rho}^\top(b, r_s)
    \BF{A_1}
    \BF{R}'(-\theta)
    \BF{R}(i, \lambda, \vartheta)
    \BF{y}
    \quad.
\end{proof}
%

\section{The Solution: Occultation}
\label{sec:solution-occ}

\begin{figure}[t!]
    \begin{centering}
        \includegraphics[width=\linewidth]{figures/cases.pdf}
        \oscaption{cases}{%
            The eight families of cases of occultations in reflected light.
            In these figures, the body with the solid outline
            is the one whose flux we are interested in, and the body with the
            dashed outline is the occultor.
            The night side of the occulted body is colored
            black (dark grey if occulted), and the dayside is colored blue
            (light grey if occulted).
            The cases in the top row involve
            configurations in which the limb of the occultor does not intersect
            with the terminator at any point, so the visible flux may be
            computed in terms of classical \starry integrals. The remaining
            cases require integration along the red boundary (the curves
            $\mathcal{P}$, $\mathcal{T}$, and $\mathcal{Q}$ of
            \S\ref{sec:cases-5-8}), which
            include the terminator. These involve the evaluation of incomplete
            elliptic integrals and are derived below.
            \label{fig:cases}
        }
    \end{centering}
\end{figure}

The integration in the unocculted case presented above is relatively
straightforward, since
the boundaries of integration are always the half-ellipse defining the
terminator and the half-circle defining the upper limb of the body
(Equation~\ref{eq:rT}). When an occultor is present, however, the
integration boundaries are far less trivial, since they may or may not
include sections of the terminator, sections of the limb of the body,
and sections of the limb of the occultor. There are in total eight families of
configurations, each defined by a distinct combination of integration
boundaries; these are shown in Figure~\ref{fig:cases}.
Together, these cases encompass all possible
occultation configurations, for any illumination angle, occultor size, and
occultor position.

Before we discuss how to compute the occultation integrals, we must first
develop a procedure to identify the relevant case given the occultor
position $(x_o, y_o)$ and radius $r_o$ and the terminator semi-minor
axis $b$ and angle $\theta$. Then, once the case is determined, we must
identify the relevant integration boundaries, which depend on the points
of intesection between the limb of the body, the limb of the occultor, and
the terminator. We do so in the following section.

\subsection{Case determination and integration boundaries}
\label{sec:which-case}
%
The key to identifying the case corresponding to a given configuration is
to determine whether or not the limb of the occultor intersects the terminator
of the body, and if so, the points of intersection.
Switching momentarily to the frame $\mathcal{F}_\mathrm{term}$,
the equations defining the
\begin{align}
    y_1(x) & = b \sqrt{1 - x^2}
    \nonumber                                       \\
    y_2(x) & = y'_o \pm \sqrt{r_o^2 - (x - x'_o)^2}
\end{align}
%
where $x'_o = $ and $y'_o = $ are the coordinates of the occultor in
$\mathcal{F}_\mathrm{term}$.


Recall that we perform the integration in frame
$\mathcal{F}_\mathrm{greens}$, in which the occultor lies along the $+y$-axis
at $(0, b_o)$, with $b_o = \sqrt{x_o^2 + y_o^2}$. In this frame, the
semi-major axis of the terminator is at an angle $\theta$ with respect to the
$+x$-axis (Equation~\ref{eq:theta}).

\subsection{Cases 1--4}
\label{sec:cases-1-4}
%
Cases 1--4 (see Figure~\ref{fig:cases}) involve configurations in which the
occultor does not intersect with
the terminator of the occulted body, and are therefore fairly
straightforward to solve.
%
Case 1 corresponds to any complete occultation of the body, so the
solution for the flux is trivial:
%
\begin{align}
    \label{eq:sT1}
    f_1 = 0
    \quad.
\end{align}
%
Case 2 involves any occultation in which the occultor blocks \emph{only} the
night side of the body (regardless of whether or not it intersects with the
limb of the body). Since the night side intensity is zero everywhere, this case
is also trivial, as the flux is equal to the flux in the no occultation case
(Equation~\ref{eq:f0}):
%
\begin{align}
    \label{eq:sT2}
    f_2 = f_0
    \quad.
\end{align}
%
Case 3 corresponds to occultations in which the occultor blocks \emph{all} of
the night side of the body and \emph{some} of the day side. In this
configuration, the unocculted part of the disk consists only of dayside.
Since we have no intersections with the terminator to worry about,
we may compute the total flux using the \starry formalism from
\citet{Luger2019}, provided we weight the intensity map by the illumination
field:
%
\begin{proof}{}
    \label{eq:f3}
    f_3 = \sTe(b_o, r_o)
    \BF{A_2}
    \BF{I}(b, \theta, r_s)
    \BF{A_1}
    \BF{R}'(\omega)
    \BF{R}(i, \lambda, \vartheta)
    \BF{y}
    \quad.
\end{proof}
%
Finally, case 4 involves any occultation in which the occultor blocks
\emph{only} the day side of the body (regardless of whether or not it
intersects with the limb):
%
\begin{proof}{}
    \label{eq:sT4}
    f_4 = f_3 + \hat{f}_0
    \quad,
\end{proof}
%
where we define
%
\begin{proof}{}
    \label{eq:f0hat}
    \hat{f}_0 & =
    \BS{\rho}^\top(-b, r_s)
    \BF{A_1}
    \BF{R}'(-\theta - \pi)
    \BF{R}(i, \lambda, \vartheta)
    \BF{y}
    \quad.
\end{proof}

%

\subsection{Cases 5--8}
\label{sec:cases-5-8}
%
\xxx{Cases 5--8} (see Figure~\ref{fig:cases}, Figure~\ref{fig:geometry}).

% case 5: sT0 - sT0 * I
% case 6: (sTe + sT0) * I + ~sT0
% case 7: (sTe - sT0) * I
% case 8: sT0 * I

\begin{figure}[t!]
    \begin{centering}
        \includegraphics[width=\linewidth]{figures/geometry.pdf}
        \oscaption{geometry}{%
            Geometry of an occultation in reflected light, corresponding
            to case 5 in Figure~\ref{fig:cases}. The surface integral over
            the blue region is computed from the antiderivatives of the
            surface intensity map counter-clockwise along the boundary curves
            $\mathcal{P}$, $\mathcal{T}$, and $\mathcal{Q}$.
            \label{fig:geometry}
        }
    \end{centering}
\end{figure}


\section{Performance}
\label{sec:performance}
%
\xxx{Performance!} See Figure~\ref{fig:speed}.
%
\begin{figure}[h!]
    \begin{centering}
        \includegraphics[width=\linewidth]{figures/speed.pdf}
        \oscaption{speed}{%
            Evaluation time for the starry algorithm.
            \label{fig:speed}
        }
    \end{centering}
\end{figure}

\appendix

\xxx{Work in progress below here.}

\section{The \starry formalism}
\label{app:starry}
%
Equations:
%
\begin{align}
    \label{eq:R}
    \BF{R} = ?
\end{align}
%
\begin{align}
    \label{eq:by}
    \by = ?
\end{align}
%
\begin{align}
    \label{eq:bp}
    \bp & =
    \begin{pmatrix}
        1   &
        x   & z  & y  &
        x^2 & xz & xy & yz & y^2 &
        \cdot\cdot\cdot
    \end{pmatrix}^\mathsf{T}
    \quad,
\end{align}
%
\begin{align}
    \label{eq:A1}
    \BF{A_1} = ?
\end{align}
%
\begin{align}
    \label{eq:rTe}
    \rTe = ?
\end{align}
%
\begin{align}
    \label{eq:R'}
    \BF{R}' = ?
\end{align}
%
\begin{align}
    \label{eq:A}
    \BF{A} = ?
\end{align}
%
\begin{align}
    \label{eq:sTe}
    \sTe = ?
\end{align}
%
The basis $\bg$ is called the \emph{Green's basis}; its name
stems from the fact that its components have a structure that makes integration
by Green's theorem convenient. Its components were defined in
Equation~11 of \citet{Luger2019b}:
%
\begin{proof}{bg}
    \tilde{g}_{l,m} &=
    \begin{dcases}
        %
        \frac{\mu+2}{2}x^\frac{\mu}{2} y^\frac{\nu}{2}
         & \qquad \mu, \nu \, \mathrm{even}
        \\[1em]
        %
        z(x, y)
         & \qquad \mu = \nu = 1
        \\[1em]
        %
        3x^{l-2}yz(x, y)
         & \qquad \nu \, \mathrm{odd}, \,
        \mu = 1, \,
        \frac{\mu + \nu}{2} \, \mathrm{even}
        \\[1em]
        %
        z(x, y)
        \bigg(
        -x^{l-3} + x^{l-1} + 4x^{l-3}y^2
        \bigg)
         & \qquad \nu \, \mathrm{odd}, \,
        \mu = 1, \,
        \, \mathrm{odd}
        \\[1em]
        %
        z(x, y)
        \bigg(
        \frac{\mu-3}{2} x^\frac{\mu-5}{2} y^\frac{\nu-1}{2}
        \ - \
        \frac{\mu-3}{2} x^\frac{\mu-5}{2} y^\frac{\nu+3}{2}
        \\
        \qquad\qquad \ - \
        \frac{\mu+3}{2} x^\frac{\mu-1}{2} y^\frac{\nu-1}{2}
        \bigg)
         & \qquad \mathrm{otherwise}
        \quad,
    \end{dcases}
    \label{eq:bg}
\end{proof}
%
where $x$ and $y$ are the Cartesian coordinates on the surface
of the projected
disk of the body, with $z(x, y) = \sqrt{1 - x^2 - y^2}$, and
%
\begin{align}
    \label{eq:munu}
    \mu & = l - m
    \nonumber     \\
    \nu & = l + m
    \quad.
\end{align}
%
The vector $\bg$ is ordered such that
the component at index $n$ is $\tilde{g}_{l,m}$, with
%
\begin{align}
    \label{eq:lm}
    l & = \floor*{\sqrt{n}} \nonumber \\
    m & = n - l^2 - l
    \quad.
\end{align}
%
Finally, the rotation matrix $\BF{R} = \BF{R}(i, \lambda, \vartheta)$
rotates the body to the correct orientation on the sky given its
inclination $i$, obliquity $\lambda$, and rotational phase $\vartheta$,
while $\BF{R}'$ rotates the body on the plane
of the sky into the frame $\mathcal{F}'$ in which the integration is
actually performed, with the occultor along the $+y$-axis.
For more information on all of these terms, the reader is referred to
\citet{Luger2019}.

The \emph{polynomial basis} $\bp$
\citep[Equation 7 in][]{Luger2019}:
%
\begin{align}
    \tilde{p}_{l,m}(x, y) & =
    \begin{dcases}
        x^\frac{\mu}{2} y^\frac{\nu}{2}
         & \qquad \mu, \nu \, \mathrm{even}
        \\[1em]
        x^\frac{\mu-1}{2} y^\frac{\nu-1}{2} z(x, y)
         & \qquad \mathrm{otherwise} \quad,
    \end{dcases}
\end{align}
%
where $\bp$ is again ordered such that the component at
index $n$ is $\tilde{p}_{l,m}$, with $l$ and $m$ given by
Equation~(\ref{eq:lm}).

As in \citet{Luger2019}, the elements of the solution vector $\mathbf{s}^\top$
are given by the line integral
%
\begin{align}
    \label{eq:s}
    s_{n(\mu,\nu)} = \oint \mathbf{G}_{\mu,\nu} \cdot \dd\mathbf{r}
\end{align}
%
where
%
\begin{align}
    \label{eq:G}
    \BF{G}_{\mu,\nu} (x, y) & =
    \begin{dcases}
        %
        x^{\frac{\mu + 2}{2}}
        y^{\frac{\nu}{2}}
        \,\yhat
         & \qquad \mu, \nu \, \mathrm{even}
        \\[1em]
        %
        \frac{1-z(x, y)^3}{3(1-z(x, y)^2)}\bigg(-y \, \xhat + x \, \yhat\bigg)
         & \qquad \mu = \nu = 1
        \\[1em]
        %
        x^{l-2}
        z(x, y)^3
        \,\xhat
         & \qquad \nu \, \mathrm{odd}, \,
        \mu = 1, \,
        \frac{\mu + \nu}{2} \, \mathrm{even}
        \\[1em]
        %
        x^{l-3}
        y
        z(x, y)^3
        \,\xhat
         & \qquad \nu \, \mathrm{odd}, \,
        \mu = 1, \,
        \frac{\mu + \nu}{2} \, \mathrm{odd}
        \\[1em]
        %
        x^{\frac{\mu-3}{2}}
        y^{\frac{\nu-1}{2}}
        z(x, y)^3
        \,\yhat
         & \qquad \mathrm{otherwise,}
    \end{dcases}
\end{align}
%
and
%
\begin{align}
    \dd \BF{r} & = -r \sin\varphi \, \dd \varphi \, \xhat +
    r \cos\varphi \, \dd \varphi \, \yhat
    \quad,
\end{align}
%
where $\varphi = \varphi(x, y)$ is the parametrized angle along the
arc of integration. Generally, there are at most three arcs bounding a given
closed surface of integration, which we will denote $\mathcal{P}$,
$\mathcal{Q}$, and $\mathcal{T}$. These are shown for a typical
occultor-occulted configuration in Figure~\ref{fig:geometry}.

\subsection{Definitions}
%
Define the pairwise difference operator
%
\begin{align}
    \label{eq:pairdiff}
    \Delta \BS{v} \equiv \sum_{i=0}^{\frac{N - 1}{2}}
    \left( v_{2i + 1} - v_{2i} \right)
\end{align}
%
which sums the difference of successive pairs of values in
an array $\BS{v} = \{ v_0, v_1, v_2, v_3, {\cdot\cdot\cdot}, v_N\}$.

Define the quantity
%
\begin{align}
    \label{eq:q}
    \BS{q}(k^2, \bkappa) = \sqrt{1 - \frac{\sinhalfkap[2]}{k^2}}
    \quad.
\end{align}

\subsection{$\mathcal{H}_{u,v}$}
%
The function $\mathcal{H}_{u,v}$ is given by
%
\begin{align}
    \label{eq:H}
    \mathcal{H}_{u,v}(\blambda) & =
    \lamint{
        \cos^u\varphi
        \sin^v\varphi
    }
    \quad.
\end{align}
%
The integral in this expression is the same as that in Equation (D27)
of \citet{Luger2019}, except for a change in the limits of integration.
We can compute this integral recursively given four lower boundary conditions:
%
\begin{proof}{H}
    \label{eq:Hlower}
    \mathcal{H}_{0,0}(\blambda) &= \Delta \blambda
    %
    \nonumber \\
    %
    \mathcal{H}_{1,0}(\blambda) &= \Delta \sin\blambda
    %
    \nonumber \\
    %
    \mathcal{H}_{0,1}(\blambda) &= -\Delta \cos\blambda
    %
    \nonumber \\
    %
    \mathcal{H}_{1,1}(\blambda) &= -\frac{\Delta\cos^2\blambda}{2}
    %
    \quad.
\end{proof}
%
The remaining terms may be computed by upward recursion using the
relations
%
\begin{proof}{H}
    \label{eq:Hrec1}
    \mathcal{H}_{u,v}(\blambda) &=
    \frac{
        -\Delta \left(
        \cos^{u + 1} \blambda
        \sin^{v - 1} \blambda
        \right)
        +(v - 1)\mathcal{H}_{u,v - 2}(\blambda)
    }{u + v}
\end{proof}
%
for $u < 2, v \ge 2$ and
%
\begin{proof}{H}
    \label{eq:Hrec2}
    \mathcal{H}_{u,v}(\blambda) &=
    \frac{
        \Delta \left(
        \cos^{u - 1} \blambda
        \sin^{v + 1} \blambda
        \right)
        + (u - 1)\mathcal{H}_{u - 2,v}(\blambda)
    }{u + v}
\end{proof}
%
for all remaining terms.

\subsection{$\mathcal{T}_{2}$}
%
The function $\mathcal{T}_{2}$ is given by
%
\begin{align}
    \label{eq:T2}
    \mathcal{T}_{2}(b, \bxi) & = ?
    \quad.
\end{align}

\begin{proof}{}
    \mathcal{T}_{2}(b, \bxi) &= -\sgn(b) \Delta \BS{f}(b, \bxi)
\end{proof}
%
where
%
\begin{proof}{}
    \begin{split}
        f_i(b, \xi_i) =
        \frac{1}{3}\scalebox{1.4}{\Bigg(}
        &\arctan\left( \frac{|b|\sin\xi_i}{\cos\xi_i} \right)
        %
        \\
        %
        &- \sgn\left({\sin\xi_i}\right)
        \left(
        \arctan
        \left(
            \frac{
                \left(\frac{\sin\xi_i}{1 + \cos\xi_i}\right)^2 + 2 b^2 - 1
            }{2 |b| \sqrt{1 - b^2}}
            \right)
        + |b| \sqrt{1 - b^2} \cos\xi_i
        \right)
        %
        \\
        %
        &+ \phi(b, \xi_i)
        \scalebox{1.4}{\Bigg)}
    \end{split}
\end{proof}
%
and
%
\begin{proof}{}
    \phi(b, \xi_i) & =
    \begin{cases}
        0                          & \qquad 0 \leq \xi_i < \frac{\pi}{2}     \\
        \pi                        & \qquad \frac{\pi}{2} \leq \xi_i < \pi   \\
        2 |b| \sqrt{1 - b^2}       & \qquad \pi < \xi_i \leq \frac{3\pi}{2}  \\
        \pi + 2 |b| \sqrt{1 - b^2} & \qquad \frac{3\pi}{2} \leq \xi_i < 2\pi
        \quad.
    \end{cases}
\end{proof}

\subsection{$\mathcal{U}_v$}
%
The function $\mathcal{U}_v$ is given by
%
\begin{align}
    \label{eq:U}
    \mathcal{U}_v(\bkappa) =
    \kapint{\cos\varphi\sin^{2v}\varphi}
    \quad.
\end{align}
%
This integral has an analytic solution for all $v$:
%
\begin{proof}{U}
    \label{eq:Usol}
    \mathcal{U}_v(\bkappa) &= \frac{\Delta \sinhalfkap[v+1]}{v + 1}
    \quad.
\end{proof}
%

\subsection{$\mathcal{I}_v$}
%
The function $\mathcal{I}_v$ is given by
%
\begin{align}
    \label{eq:I}
    \mathcal{I}_v(\bkappa) & =
    \kapint{\sinhalfkap[2v]}
    \quad.
\end{align}
%
The integral in this expression is the same as that in Equation (D38)
of \citet{Luger2019}, except for a change in the limits of integration.
As in \citet{Luger2019}, we can compute this integral recursively given
a trivial lower boundary condition:
%
\begin{proof}{I}
    \label{eq:Irec}
    \mathcal{I}_0(\bkappa) &=
    \frac{\Delta \bkappa}{2}
    %
    \nonumber \\
    %
    \mathcal{I}_v(\bkappa) &=
    \frac{1}{2v}
    \bigg(
    (2v - 1) \mathcal{I}_{v-1}(\bkappa) -
    \Delta \left(\sinhalfkap[2v - 1]\coshalfkap\right)
    \bigg)
\end{proof}
%
where the last expression is valid for all $v > 0$. We find that this algorithm
is generally stable, except when $\sin\left(\frac{\bkappa}{2}\right)$ is small.
In that limit, we evaluate $\mathcal{I}_N(\bkappa)$ by numerical integration of
Equation~(\ref{eq:I}) using Gauss-Legendre quadrature with \STARRYQUADPOINTS
points. We then recurse downward by substituting $v \rightarrow v + 1$ in
Equation~(\ref{eq:Irec}) and solving for $\mathcal{I}_v(\bkappa)$.

\subsection{$\mathcal{J}_v$}
%
The function $\mathcal{J}_v$ is given by
%
\begin{align}
    \label{eq:J}
    \mathcal{J}_v(k^2, \bkappa) =
    \kapint{
        \sin^{2v}\varphi
        \left(1 - \frac{\sin^2\varphi}{k^2}\right)^\frac{3}{2}
    }
    \quad.
\end{align}
%
The integral in this expression is again the same as that in Equation (D39)
of \citet{Luger2019}, except for a change in the limits of integration.
In that paper, we computed all terms
$\{ \mathcal{J}_0, {\cdot\cdot\cdot}, \mathcal{J}_\vmax \}$ from a three-term
recurrence relation and two boundary conditions. In the case of upward
recursion, the boundary conditions $\mathcal{J}_0$ and $\mathcal{J}_1$ were
computed analytically from the complete elliptic integrals $K(k^2)$
and $E(k^2)$. In cases where upward recursion was not numerically stable, we
evaluated $\mathcal{J}_\vmax$ and $\mathcal{J}_{\vmax-1}$
via a quickly convergent series expansion and recursed downward.

In order to solve Equation~(\ref{eq:J}), it is possible to
replace the complete elliptic integrals $K(k^2)$ and $E(k^2)$ in the lower
boundary conditions \citep[Equation D46 in ][]{Luger2019} with the
incomplete elliptic integrals $F(k^2, \kappa)$ and $E(k^2, \kappa)$,
then use the same upward
recursion relation to obtain analytic solutions for all $\mathcal{J}_v$:
%
\begin{proof}{J}
    \label{eq:Jrec}
    \mathcal{J}_0(k^2, \bkappa) &=
    \frac{1}{3} \bigg(
    2 \left(2 - \frac{1}{k^2}\right) \DE +
    \left(\frac{1}{k^2} - 1\right) \DF +
    \Delta \BS{z}_0(k^2, \bkappa)
    \bigg)
    %
    \nonumber \\
    %
    \mathcal{J}_1(k^2, \bkappa) &=
    \frac{1}{15} \bigg(
    \left(-3 k^2 + 13 - \frac{8}{k^2}\right) \DE +
    \left(3 k^2 - 7 + \frac{4}{k^2}\right) \DF +
    \Delta \BS{z}_1(k^2, \bkappa)
    \bigg)
    %
    \nonumber \\
    %
    \mathcal{J}_v(k^2, \bkappa) &=
    \frac{1}{2v + 3}
    \bigg(
    2 \left( v + 1 + (v - 1) k^2 \right) \mathcal{J}_{v - 1} -
    (2v - 3) k^2 \mathcal{J}_{v - 2}
    + \Delta \BS{z}_v(k^2, \bkappa)
    \bigg)
\end{proof}
%
%
where the last expression is valid for all $v > 1$ and
%
\begin{proof}{J}
    \label{eq:Jrec_z}
    \BS{z}_0(k^2, \BS{\kappa}) & =
    \frac{
        \sinhalfkap
        \coshalfkap
        \BS{q}(k^2, \bkappa)
    }{
        k^2
    }
    %
    \nonumber\\
    %
    \BS{z}_1(k^2, \BS{\kappa}) & =
    \left(\left(3 \sinhalfkap[2] + 4\right) - 6k^2\right)
    \BS{z}_0(k^2, \BS{\kappa})
    %
    \nonumber\\
    %
    \BS{z}_v(k^2, \BS{\kappa}) & =
    k^2
    \sinhalfkap[2v - 3]
    \coshalfkap
    \BS{q}(k^2, \BS{\kappa})^5
    \quad.
\end{proof}
%
However, in practice we find that this procedure is even more numerically
unstable than it was in \citet{Luger2019}.
To address this, we express the recurrence structure of the problem as
a tridiagonal system with one lower boundary condition $\mathcal{J}_0$
and one upper boundary condition $\mathcal{J}_\vmax$:
%
\begin{proof}{J}
    \label{eq:Jtri}
    \begin{pmatrix}
        a_0 & 1   &     &        &         &         \\
        b_1 & a_1 & 1   &        &         &         \\
            & b_2 & a_2 & 1      &         &         \\
            &     & b_0 & a_3    & 1       &         \\
            &     &     & \ddots & \ddots  & \ddots  \\
            &     &     &        & b_\vmax & a_\vmax
    \end{pmatrix}
    \begin{pmatrix}
        \mathcal{J}_1   \\
        \mathcal{J}_2   \\
        \mathcal{J}_3   \\
        \mathcal{J}_4   \\
        \cdot\cdot\cdot \\
        \mathcal{J}_{\vmax-1}
    \end{pmatrix}
    =
    \begin{pmatrix}
        c_0 - b_0 \mathcal{J}_0 \\
        c_1                     \\
        c_2                     \\
        c_3                     \\
        \cdot\cdot\cdot         \\
        c_\vmax - \mathcal{J}_\vmax
    \end{pmatrix}
\end{proof}
%
where the recursion coefficients are given by
%
\begin{proof}{J}
    \label{eq:Jtri_coeffs}
    a_v(k) &= -2\frac{(v + 1) + (v - 1) k^2}{2v + 3} \nonumber \\
    b_v(k) &= \frac{(2v - 3) k^2}{2v + 3} \nonumber \\
    c_v(k^2, \bkappa) &= \Delta
    \bigg(
    \frac{
            \BS{z}_v(k^2, \BS{\kappa})
        }{
            2v + 3
        }
    \bigg)
    \quad.
\end{proof}
%
Solving this matrix system yields values for all
intermediate $\{ \mathcal{J}_1, {\cdot\cdot\cdot}, \mathcal{J}_{\vmax - 1} \}$.
While efficient algorithms exist for solving tridiagonal problems, we obtain
far better numerical stability by instead performing traditional LU
decomposition. We find that this algorithm is stable in all the regimes that we
tested.

We evaluate the upper boundary condition $\mathcal{J}_{\vmax}$ by numerical
integration of Equation~(\ref{eq:J}) via Gauss-Legendre quadrature with
\STARRYQUADPOINTS points. While the lower boundary condition may be computed
analytically from Equation~(\ref{eq:Jrec}),
in practice we achieve better precision via numerical
integration (as above), with negligible effects on computational performance.

\subsection{$\mathcal{W}_n$}
%
The function $\mathcal{W}_n$ is given by
%
\begin{align}
    \label{eq:W}
    % TODO
    \mathcal{W}_n = \int
\end{align}
%
This integral has a closed-form solution:
%
\begin{proof}{}
    \label{eq:Wsol}
    \mathcal{W}_n =
    \frac{\sin^{2n + 2}\left(\frac{\bkappa}{2}\right)}{2n + 5}
    \left(
    \frac{3}{n+1}
        {_2F_1}\left(-\frac{1}{2}, n + 1; n + 2; 1 - q^2\right) + 2 q^3
    \right)
\end{proof}
%
where ${_2F_1}(a, b; c; z)$ is the Gauss hypergeometric function.


% by either upward recursion (stable for |1 - q^2| > 1/2) or downward
% recursion (always stable).

% Bibliography
\bibliography{bib}


\end{document}
